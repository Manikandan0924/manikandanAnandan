<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./libs/css/style.css">
    <link rel="stylesheet" href="./libs/css/bootstrap.min.css">
    <link rel="stylesheet" href="fontawesome-free-6.5.1-web/fontawesome-free-6.5.1-web/css/all.css"/>
    <link rel="stylesheet" href="./libs/css/all.min.css">
</head>
<body>
    <section>

        <div class="appHeader">
      
          <div class="row">
      
            <div class="col">
              <input id="searchInp" class="form-control mb-3" placeholder="search">
            </div>
      
            <div class="col-6 text-end me-2">
      
              <div class="btn-group" role="group" aria-label="buttons">
      
                <button id="refreshBtn" type="button" class="btn btn-primary">
                  <i class="fa-solid fa-refresh fa-fw"></i>
                </button>
                <button id="filterBtn" type="button" class="btn btn-primary">
                  <i class="fa-solid fa-filter fa-fw"></i>
                </button>          
                <button id="addBtn" type="button" class="btn btn-primary">
                  <i class="fa-solid fa-plus fa-fw"></i>
                </button>
      
              </div>
      
            </div>
            
          </div>
      
          <ul class="nav nav-tabs" id="myTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="personnelBtn" data-bs-toggle="tab" data-bs-target="#personnel-tab-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">
                  <i class="fa-solid fa-person fa-lg fa-fw"></i><span class="d-none d-sm-block">Personnel</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="departmentsBtn" data-bs-toggle="tab" data-bs-target="#departments-tab-pane" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">
                  <i class="fa-solid fa-building fa-lg fa-fw"></i><span class="d-none d-sm-block">Departments</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="locationsBtn" data-bs-toggle="tab" data-bs-target="#locations-tab-pane" type="button" role="tab" aria-controls="contact-tab-pane" aria-selected="false">
                  <i class="fa-solid fa-map-location-dot fa-lg fa-fw"></i><span class="d-none d-sm-block">Locations</span>
                </button>
              </li>
      
            </ul>
      
        </div>
      
        <div class="tab-content bg-white">
      
          <div class="tab-pane show active" id="personnel-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
            
            <table class="table table-hover">
              
              <tbody id="personnelTableBody">
              
                <!-- Below is an example row. Create a JS function that interogates the database and 
                dynamically creates the HTML for the table contents. -->
      
                <tr>
                  <td class="align-middle text-nowrap">
                    Ace, Tamarra
                  </td>
                  <td class="align-middle text-nowrap d-none d-md-table-cell">
                    Support
                  </td>
                  <td class="align-middle text-nowrap d-none d-md-table-cell">
                    Munich
                  </td>
                  <td class="align-middle text-nowrap d-none d-md-table-cell">
                    tacem@vinaora.com
                  </td>
                  <td class="text-end text-nowrap">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editPersonnelModal" data-id="23">
                      <i class="fa-solid fa-pencil fa-fw"></i>
                    </button>
                    <button type="button" class="btn btn-primary btn-sm deletePersonnelBtn" data-id="23">
                      <i class="fa-solid fa-trash fa-fw"></i>
                    </button>
                  </td>
                </tr>
                
              </tbody>
      
            </table>
            
          </div>
      
          <div class="tab-pane" id="departments-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
            
            <table class="table table-hover">
              
              <tbody id="departmentTableBody">
              
                <!-- Below is an example row. Create a JS function that interogates the database and 
                dynamically creates the HTML for the table contents. -->
      
                <tr>
                  <td class="align-middle text-nowrap">
                    Human resources
                  </td>
                  <td class="align-middle text-nowrap d-none d-md-table-cell">
                    London
                  </td>
                  <td class="align-middle text-end text-nowrap">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#deleteDepartmentModal" data-id="1">
                      <i class="fa-solid fa-pencil fa-fw"></i>
                    </button>
                    <button type="button" class="btn btn-primary btn-sm deleteDepartmentBtn" data-id="1">
                      <i class="fa-solid fa-trash fa-fw"></i>
                    </button>
                  </td>
                </tr> 
                
              </tbody>
      
            </table>
            
          </div>
      
          <div class="tab-pane" id="locations-tab-pane" role="tabpanel" aria-labelledby="contact-tab" tabindex="0">
            
            <table class="table table-hover">
            
              <tbody id="locationTableBody">
                
                <!-- Below is an example row. Create a JS function that interogates the database and 
                dynamically creates the HTML for the table contents. -->
      
                <tr>
                  <td class="align-middle text-nowrap">
                    London
                  </td>
                  <td class="align-middle text-end text-nowrap">
                    <button type="button" class="btn btn-primary btn-sm">
                      <i class="fa-solid fa-pencil fa-fw"></i>
                    </button>
                    <button type="button" class="btn btn-primary btn-sm">
                      <i class="fa-solid fa-trash fa-fw"></i>
                    </button>
                  </td>
                </tr>
                
              </tbody>
      
            </table>
            
          </div>
      
        </div>
        
        <footer class="border-top text-center fw-bold">
          
          <p class="fw-light my-3">Company Directory version 1.0</p>
          
        </footer
      
      </section>
          
      <div id="editPersonnelModal" class="modal fade" tabindex="-1" data-bs-backdrop="false" data-bs-keyboard="false" aria-labelledby="exampleModalLabel" aria-hidden="true">
        

        <!--   the last two classes centre the modal and, if the content is too long, ensures  -->
        <!--   that the header and footer are always on display by making the body scroll -->
        
        <div class="modal-dialog modal-sm modal-dialog-centered modal-dialog-scrollable">
             
          <div class="modal-content shadow"> 
            
            <div class="modal-header bg-primary bg-gradient text-white">
              <h5 class="modal-title">Edit employee</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
      
            <div class="modal-body">
                
              <form id="editPersonnelForm">
      
                <input type="hidden" id="editPersonnelEmployeeID">
      
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="editPersonnelFirstName" placeholder="First name" required>
                  <label for="editPersonnelFirstName">First name</label>
                </div>
      
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="editPersonnelLastName" placeholder="Last name" required>
                  <label for="editPersonnelLastName">Last name</label>
                </div>
      
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="editPersonnelJobTitle" placeholder="Job title" required>
                  <label for="editPersonnelJobTitle">Job Title</label>
                </div>          
      
                <div class="form-floating mb-3">
                  <input type="email" class="form-control" id="editPersonnelEmailAddress" placeholder="Email address" required>
                  <label for="editPersonnelEmailAddress">Email Address</label>
                </div>    
      
                <div class="form-floating">
                  <select class="form-select" id="editPersonnelDepartment" placeholder="Department">
                  </select>
                  <label for="editPersonnelDepartment">Department</label>
                </div>  
      
              </form>
      
            </div>
      
            <div class="modal-footer">
              <button type="submit" form="editPersonnelForm" class="btn btn-outline-primary btn-sm myBtn">SAVE</button>
              <button type="button" class="btn btn-outline-primary btn-sm myBtn" data-bs-dismiss="modal">CANCEL</button>
            </div>
       
          </div>
          
        </div>
        
      </div>
          
      <script src="./libs/js/jquery.min.js"></script>
      <script src="./libs/js/bootstrap.bundle.min.js"></script>
      <script src="./libs/js/test.js"></script>  
</body>
</html>


















// Function to generate personnel table
function generatePersonnelTable(data, tableBodyId) {
    let tableHtml = '';
    data.forEach(entry => {
        tableHtml += '<tr>';
        tableHtml += `<td>${entry.lastName}, ${entry.firstName}</td>`;
        tableHtml += `<td>${entry.department}</td>`;
        tableHtml += `<td>${entry.location}</td>`;
        tableHtml += `<td>${entry.email}</td>`;
        tableHtml += '<td class="text-end">';
        tableHtml += `<button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editPersonnelModal" data-id="${entry.id}">
          <i class="fa-solid fa-pencil fa-fw"></i>
        </button>`;
        tableHtml += '&nbsp;';
        tableHtml += `<button class="btn btn-primary btn-sm Personnel-delete-btn" data-id="${entry.id}" data-name="${entry.firstName} ${entry.lastName}">
          <i class="fa-solid fa-trash fa-fw"></i>
        </button>`;
        tableHtml += '</td>';
        tableHtml += '</tr>';
    });
    $('#' + tableBodyId).html(tableHtml);
}

// Function to fetch and generate table
function fetchAndGenerateTable(searchText, tableBodyId) {
    $.ajax({
        url: "php/getAll.php",
        type: "GET",
        dataType: "json",
        data: {
            txt: searchText
        },
        success: function (response) {
            generatePersonnelTable(response.data, tableBodyId);
        },
        error: function (xhr, status, error) {
            // Handle errors here
        }
    });
}

// Function to populate department dropdown in the filter modal
function populateFilterDepartmentDropdown() {
    $.ajax({
        url: "php/getAllDepartments.php",
        type: "GET",
        dataType: "json",
        success: function(response) {
            $('#departmentSelect').empty();
            $.each(response.data, function(index, department) {
                $('#departmentSelect').append($('<option>', {
                    value: department.name,
                    text: department.name
                }));
            });
        },
        error: function(xhr, status, error) {
            // Handle error if needed
        }
    });
}

// Function to fetch and generate filtered table based on selected department
function fetchAndGenerateFilteredTable(selectedDepartment) {
    $.ajax({
        url: "php/getFilteredPersonnel.php",
        type: "GET",
        dataType: "json",
        data: {
            departmentName: selectedDepartment
        },
        success: function (response) {
            generatePersonnelTable(response.data, 'personnelTableBody');
        },
        error: function (xhr, status, error) {
            // Handle errors here
        }
    });
}

// Function to populate the department dropdown in the add personnel modal
function populatePersonnelDepartmentDropdown() {
    $.ajax({
        url: "php/getDepartmentDetails.php",
        type: "GET",
        dataType: "json",
        success: function(response) {
            $('#addPersonnelDepartment').empty();
            $.each(response.data, function(index, department) {
                $('#addPersonnelDepartment').append($('<option>', {
                    value: department.id,
                    text: department.name
                }));
            });
        },
        error: function(xhr, status, error) {
            // Handle error if needed
        }
    });
}

// Function to handle the submission of the "Add Personnel" form
$("#addPersonnelForm").click(function () {
    // AJAX request to send data to the server
    $.ajax({
        url: "php/createPersonnel.php",
        type: "POST",
        dataType: "json",
        data: {
            // Add your form data here
        },
        success: function (response) {
            if (response.status.code === "200") {
                $("#addpersonnelModal").modal("hide");
                refreshPersonnelTable();
            } else {
                alert("Failed to add personnel. Please try again.");
            }
        },
        error: function (xhr, status, error) {
            alert("AJAX error: " + error);
        }
    });
});

// Function to refresh the personnel table
function refreshPersonnelTable() {
    var searchText = $("#searchInp").val().trim();
    fetchAndGenerateTable(searchText, 'personnelTableBody');
}

// Event listener for modal show event
$(document).on('show.bs.modal', '#editPersonnelModal', function(e) {
    $.ajax({
        url: "php/getPersonnelByID.php",
        type: "POST",
        dataType: "json",
        data: {
            id: $(e.relatedTarget).attr("data-id")
        },
        success: function (result) {
            var resultCode = result.status.code;

            if (resultCode == 200) {
                $("#editPersonnelEmployeeID").val(result.data.personnel[0].id);
                $("#editPersonnelFirstName").val(result.data.personnel[0].firstName);
                $("#editPersonnelLastName").val(result.data.personnel[0].lastName);
                $("#editPersonnelJobTitle").val(result.data.personnel[0].jobTitle);
                $("#editPersonnelEmailAddress").val(result.data.personnel[0].email);

                $("#editPersonnelDepartment").html("");

                $.each(result.data.department, function () {
                    $("#editPersonnelDepartment").append(
                        $("<option>", {
                            value: this.id,
                            text: this.name
                        })
                    );
                });

                $("#editPersonnelDepartment").val(result.data.personnel[0].departmentID);
            } else {
                $("#editPersonnelModal .modal-title").replaceWith("Error retrieving data");
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {
            $("#editPersonnelModal .modal-title").replaceWith("Error retrieving data");
        }
    });
});

// Edit personnel form submission
$(document).on("submit", "#editPersonnelForm", function (e) {
    e.preventDefault(); // Prevent default form submission

    var editPersonnelId = $('#editPersonnelEmployeeID').val();
    var editPersonnelFirstName = $('#editPersonnelFirstName').val();
    var editPersonnelLastName = $('#editPersonnelLastName').val();
    var editPersonnelEmailAddress = $('#editPersonnelEmailAddress').val();
    var editPersonnelDepartment = $('#editPersonnelDepartment').val();

    // AJAX request to send data to the server for updating the personnel
    $.ajax({
        url: "php/EditPersonnel.php",
        type: "POST",
        dataType: "json",
        data: {
            id: editPersonnelId,
            firstName: editPersonnelFirstName,
            lastName: editPersonnelLastName,
            email: editPersonnelEmailAddress,
            departmentID: editPersonnelDepartment
        },
        success: function (response) {
            if (response.status.code === "200") {
                // Close the modal after successful editing of personnel
                $("#editPersonnelModal").modal("hide");
                // Optionally, refresh the personnel table to reflect the changes
                fetchAndGenerateTable($("#searchInp").val().trim(), 'personnelTableBody');
            } else {
                alert("Failed to update personnel. Please try again.");
            }
        },
        error: function (xhr, status, error) {
            alert("AJAX error: " + error);
        }
    });
});

// Other event listeners and functions...

// Initial table generation
fetchAndGenerateTable(null, 'personnelTableBody');


// Event listener for filter button click to open the modal
$('#filterBtn').click(function () {
    $('#filterModal').modal('show'); // Manually show the filter modal
});

// Event listener for filter modal shown event
$('#filterModal').on('show.bs.modal', function (e) {
    // Populate department dropdown when filter modal is shown
    populateFilterDepartmentDropdown();
});

// Event listener for apply filter button click
$('#applyFilterBtn').click(function () {
    var selectedDepartment = $('#departmentSelect').val();
    // Call a function to fetch and generate filtered table based on selectedDepartment
    // Pass selectedDepartment to the server-side script to filter data
    fetchAndGenerateFilteredTable(selectedDepartment);
    // Close the filter modal
    $('#filterModal').modal('hide');
});

// Function to populate department dropdown in the filter modal
function populateFilterDepartmentDropdown() {
    $.ajax({
        url: "php/getAllDepartments.php",
        type: "GET",
        dataType: "json",
        success: function(response) {
            // Clear existing dropdown options
            $('#departmentSelect').empty();
            // Populate dropdown with fetched departments
            $.each(response.data, function(index, department) {
                $('#departmentSelect').append($('<option>', {
                    value: department.name,
                    text: department.name
                }));
            });
        },
        error: function(xhr, status, error) {
            // Handle error if needed
        }
    });
}

// Function to fetch and generate filtered table based on selected department
function fetchAndGenerateFilteredTable(selectedDepartment) {
    $.ajax({
        url: "php/getFilteredPersonnel.php",
        type: "GET",
        dataType: "json",
        data: {
            departmentName: selectedDepartment
        },
        success: function (response) {
            // Handle the response data here
            generatePersonnelTable(response.data, 'personnelTableBody');
        },
        error: function (xhr, status, error) {
            // Handle errors here
        }
    });
}

// Other event listeners and functions...

// Event listener when the add personnel modal is shown
$('#addpersonnelModal').on('shown.bs.modal', function (e) {
    // Populate the department dropdown when the modal is shown
    populatePersonnelDepartmentDropdown();
});

// Function to populate the department dropdown in the add personnel modal
function populatePersonnelDepartmentDropdown() {
    $.ajax({
        url: "php/getDepartmentDetails.php",
        type: "GET",
        dataType: "json",
        success: function(response) {
            // Clear existing dropdown options
            $('#addPersonnelDepartment').empty();
            // Populate dropdown with fetched departments
            $.each(response.data, function(index, department) {
                $('#addPersonnelDepartment').append($('<option>', {
                    value: department.id,
                    text: department.name
                }));
            });
        },
        error: function(xhr, status, error) {
            // Handle error if needed
        }
    });
}

// Function to handle the submission of the "Add Personnel" form
$("#addPersonnelForm").submit(function (e) {
    e.preventDefault(); // Prevent default form submission

    // Get the personnel details from the input fields
    var addPersonnelFirstName = $("#addPersonnelFirstName").val();
    var addPersonnelLastName = $("#addPersonnelLastName").val();
    var addPersonnelEmailAddress = $("#addPersonnelEmailAddress").val();
    var addPersonnelDepartment = $("#addPersonnelDepartment").val();

    // AJAX request to send data to the server
    $.ajax({
        url: "php/createPersonnel.php",
        type: "POST",
        dataType: "json",
        data: {
            firstName: addPersonnelFirstName,
            lastName: addPersonnelLastName,
            email: addPersonnelEmailAddress,
            departmentID: addPersonnelDepartment
        },
        success: function (response) {
            // Check if the server successfully processed the request
            if (response.status.code === "200") {
                // Close the modal after successful addition of personnel
                $("#addpersonnelModal").modal("hide");
                // Refresh the table to reflect the changes
                refreshPersonnelTable();
            } else {
                // Display error message if server-side operation failed
                alert("Failed to add personnel. Please try again.");
            }
        },
        error: function (xhr, status, error) {
            // Handle AJAX errors
            alert("AJAX error: " + error);
        }
    });
});

// Other event listeners and functions...

// Event listener for delete button click
$(document).on('click', '.Personnel-delete-btn', function() {
    // Get data attributes from the button
    var personnelId = $(this).data('id');
    var personnelName = $(this).data('name');
    
    // Set data attributes in the modal for further processing
    $('#deletePersonnelModal').data('personnelId', personnelId);
    $('#deletePersonnelModal').data('personnelName', personnelName); // Add personnelName attribute
    
    // Show the delete modal
    $('#deletePersonnelModal').modal('show');
});

// Event listener for confirm delete button click
$('#confirmDeletePersonnelBtn').on('click', function() {
    // Get personnel ID and name from the modal data attributes
    var personnelId = $('#deletePersonnelModal').data('personnelId');
    var personnelName = $('#deletePersonnelModal').data('personnelName');
    
    // Call the deletePersonnel function
    deletePersonnel(personnelId, personnelName); // Pass personnelName as an argument
});

// Event listener for cancel button click for delete personnel modal
$('#cancelDeletePersonnelBtn').on('click', function() {
    // Hide the delete confirmation modal
    $('#deletePersonnelModal').modal('hide');
});

// Function to handle deletion of personnel
function deletePersonnel(personnelId, personnelName) {
    // AJAX request to send data to the server for deleting the personnel
    $.ajax({
        url: "php/deletePersonnel.php",
        type: "POST",
        dataType: "json",
        data: {
            id: personnelId
        },
        success: function (response) {
            // Check if the server successfully processed the request
            if (response.status.code === "200") {
                // Remove the deleted personnel row from the table
                $('#personnelTableBody').find('[data-id="' + personnelId + '"]').closest('tr').remove();
                
                // Hide the delete confirmation modal
                $('#deletePersonnelModal').modal('hide');
            } else {
                // Display error message if server-side operation failed
                alert("Failed to delete personnel. Please try again.");
            }
        },
        error: function (xhr, status, error) {
            // Handle AJAX errors
            alert("AJAX error: " + error);
        }
    });
}

// Initial table generation
fetchAndGenerateTable(null, 'personnelTableBody');